!function(e){"use strict";AWEContent.Models.ImageItem=AWEContent.Models.Item.extend({imageURL:"",lighBoxImageURL:"",defaults:{fid:-1,machine_name:"image",styleImage:"none",styleLightbox:"none",lightBox:1,caption:1,captionColor:"",contentCaption:"",linkExtend:"",targetImage:1,positionCaption:"top",onHover:1,imageBgOverlay:"",captionOnLightBox:1,boxModelSettings:{},customID:"",customClass:"",customEnableAttributes:1,customDataAttributes:"[]",customActionAttributes:'{"newAction": "", "newAttrName": "", "newAttrValue": ""}',customEnableAnimations:0,customDataAnimations:'{"type" : "none"}',lgResponsive:!0,xsResponsive:!0,mediumResponsive:!0,smResponsive:!0},relations:[{type:Backbone.HasOne,key:"boxModelSettings",relatedModel:AWEContent.Models.BoxModelSettings}],createView:function(){this.view=new AWEContent.Views.ImageItem({model:this})},clone:function(){var t={};return e.each(this.toJSON(),function(e,a){t[e]=a}),t.boxModelSettings=new AWEContent.Models.BoxModelSettings(t.boxModelSettings),new AWEContent.Models.ImageItem(t)}}),AWEContent.Views.ImageItem=AWEContent.Views.Item.extend({imageContent:_.template('<div class="awe-item awe-image">            <% if (link) { %>                <a href="<%= link %>" target="<%= target %>" class="mgf-md-popup">            <% } %>                <div class="awe-image-content">                    <div class="awe-image-caption"><%= caption %></div>                    <div class="awe-image-container"><img src="<%= imgSrc %>" alt="" /></div>                </div>            <% if (link) { %>            </a>            <% } %>                <div class="awe-image-control">                    <ul>                        <li class="edit-link">                            <i class="ic ac-icon-link"></i>                            <div class="awe-control-box">                                <div class="awe-box-header">Image link</div>                                 <div class="awe-box-content">                                    <div class="awe-box-item">                                        <textarea></textarea>                                    </div>                                    <div class="awe-box-item">                                        <input type="checkbox" name="target" id="ckb-target" class="ckb-target">                                        <label for="ckb-target" class="label-checkbox">Open new window</label>                                    </div>                                </div>                                <div class="awe-box-footer">                                    <a href="#" class="awe-box-btn js-ok">Save</a>                                    <a href="#" class="awe-box-btn js-cancel">Cancel</a>                                </div>                            </div>                        </li>                        <li class="edit-caption">                            <i class="ic ac-icon-caption"></i>                            <div class="awe-control-box">                                <div class="awe-box-header">Image caption</div>                                 <div class="awe-box-content">                                    <div class="awe-box-item">                                        <textarea></textarea>                                    </div>                                </div>                                <div class="awe-box-footer">                                    <a href="#" class="awe-box-btn js-ok">Save</a>                                    <a href="#" class="awe-box-btn js-cancel">Cancel</a>                                </div>                            </div>                        </li>                    </ul>                </div>            </div>'),changeImageSrc:function(){fid>0&&(this.model.set("fid",fid),AWEContent.Panels.image.setPanelElementsValue(),this.resizeItem())},initialize:function(){AWEContent.Views.Item.prototype.initialize.call(this),this.listenTo(this.model.get("boxModelSettings"),"change",this.applySettingsChanged);var t=this;this.$el.on("ready",function(){t.changeEmptyImageHeight(),e(".awe-image",e(this)).aweDragUpload({multiUpload:!1,uploadSuccessCallback:function(e){if(e.status&&e.file){var a=e.file;t.changeImageSrc(a.file_url)}}})}),t.$el.delegate(".awe-image-control li","click",function(){if(e(this).siblings("li").removeClass("active"),e(this).toggleClass("active"),e(this).hasClass("active")){var a,i=e("textarea",this);e(this).hasClass("edit-link")?a=t.model.get("linkExtend"):e(this).hasClass("edit-caption")&&(a=t.model.get("contentCaption")),i.val(a)}}),t.$el.delegate(".awe-control-box","click",function(e){e.stopPropagation()}),t.$el.delegate(".awe-image-control .awe-box-btn","click",function(a){a.preventDefault(),a.stopPropagation();var i=e(a.target).is("li")?e(a.target):e(a.target).closest("li"),o=i.find("textarea"),n=o.val();if(i.removeClass("active"),e(this).hasClass("js-ok"))if(i.hasClass("edit-link")){var l=o.next().prop("checked")?1:0;t.model.set("linkExtend",n),t.model.set("targetImage",l)}else i.hasClass("edit-caption")&&t.model.set("contentCaption",n)}),this.$el.bind("getImageURLSuccess",function(){})},changeEmptyImageHeight:function(){""==this.model.imageURL&&this.$img&&this.$img.css("min-height",.75*this.$el.width())},renderItemContent:function(){var t=this,a=t.model.toJSON(),i=!a.lightBox&&a.linkExtend&&a.targetImage?"_blank":"_self",o=a.lightBox?this.model.lighBoxImageURL:a.linkExtend,n=e(this.imageContent({link:o,target:i,imgSrc:this.model.imageURL,caption:a.contentCaption}));this.$el.aweImageURL({fid:[a.fid],styles:[a.styleImage,a.styleLightbox],success:function(e,a,i,o){t.processImageURL(e,a,i,o)}}),t.$imageWrap=n,o&&(t.$imageWrap=e("> a",n)),AWEContent.Library.addLibrary("magnific",function(){t.initMagnificPopup(n)}),a.caption?"bottom"==a.positionCaption?e(".awe-image-content",n).append(e(".awe-image-caption",n)):"over"==a.positionCaption&&(n.addClass("position-over"),a.onHover&&n.addClass("caption-hover"),e(".awe-image-content",t.$imageWrap).prepend(e('<div class="awe-image-overlay"></div>').css("background-color",a.imageBgOverlay))):n.addClass("disable-caption"),a.lightBox&&t.$imageWrap.addClass("open-lightbox"),e(".awe-image-caption",n).attr("data-on-lightbox",a.captionOnLightBox?!0:!1),n.attr("id",a.customID).addClass(a.customClass).renderItemDefaultBoxModel(a.boxModelSettings),n.renderItemDefaultAttributes(a.customEnableAttributes,a.customDataAttributes),a.customEnableAnimations&&n.processAnimations(a.customDataAnimations),t.$el.defaultResponsive(a),t.$img=e(".awe-image-container > img",n),e(".awe-image-caption",n).css("color",a.captionColor);var l=setInterval(function(){0!=t.$el.find("img").length&&(clearInterval(l),t.resizeItem())},100);return n},applySettingsChanged:function(t){var a=this,i=a.model.toJSON(),o=e(".awe-image",a.el),n=e(".awe-image-content",o),l=e(".awe-image-caption",o),s=a.$el.height();e.each(t.changedAttributes(),function(s,g){switch(a.$el.changeResponsive(s,g),o.renderChangeSettingBoxModel(s,g,t),s){case"fid":var m=t.previousAttributes().fid;-1==m&&a.$img.css({"min-height":"",background:""}),a.$el.aweImageURL({fid:[i.fid],styles:[i.styleImage,i.styleLightbox],success:function(e,t,i,o){a.processImageURL(e,t,i,o)}});break;case"styleImage":case"styleLightbox":var c=a.model.get("fid");c>0&&a.$el.aweImageURL({fid:[i.fid],styles:[i.styleImage,i.styleLightbox],success:function(e,t,i,o){a.processImageURL(e,t,i,o)}});break;case"lightBox":g?(""==i.linkExtend&&(a.$imageWrap.prepend('<a href="mgf-md-popup"></a>'),a.$imageWrap=e("> a",a.$imageWrap),a.$imageWrap.append(e(".awe-image-content",o))),a.$imageWrap.attr("href",a.model.lighBoxImageURL).addClass("open-lightbox"),e("li.edit-link",o).hide()):(""==i.linkExtend?(a.$imageWrap=o,a.$imageWrap.append(e(".awe-image-content",o)),e("> a",o).remove()):a.$imageWrap.removeClass("open-lightbox").attr("href",i.linkExtend),e("li.edit-link",o).show(),i.caption||e("li.edit-caption",o).hide());break;case"linkExtend":i.lightBox||(g?(o.prepend('<a class="mgf-md-popup" href=""></a>'),a.$imageWrap=e("> a",o).attr("href",g),a.$imageWrap.append(e(".awe-image-content",o))):(o.prepend(e(".awe-image-content",o)),e("> a.mgf-md-popup",o).remove(),a.$imageWrap=e(".awe-image-content",o)));break;case"targetImage":i.linkExtend&&a.$imageWrap.attr("target","_blank");break;case"caption":g?(e(".edit-caption",o).show(),""!=i.contentCaption&&o.removeClass("disable-caption")):(o.addClass("disable-caption"),i.captionOnLightBox&&i.lightBox||e(".edit-caption",o).hide());break;case"contentCaption":i.caption&&""!=g?(o.removeClass("disable-caption"),e(".awe-image-caption",o).html(g)):o.addClass("disable-caption");break;case"positionCaption":switch(o.removeClass("position-over").removeClass("caption-hover"),g){case"top":n.prepend(l),e(".awe-image-overlay",o).remove();break;case"bottom":n.append(l),e(".awe-image-overlay",o).remove();break;case"over":o.addClass("position-over"),i.onHover&&o.addClass("caption-hover"),e(".awe-image-content",a.$imageWrap).prepend(e('<div class="awe-image-overlay"></div>').css("background-color",i.imageBgOverlay))}break;case"onHover":g&&"over"==i.positionCaption?o.addClass("caption-hover"):o.removeClass("caption-hover");break;case"captionOnLightBox":g?(e(".edit-caption",o).show(),l.attr("data-on-lightbox",!0)):(l.attr("data-on-lightbox",!1),i.caption||e(".edit-caption",o).hide());break;case"captionColor":e(".awe-image-caption",o).css("color",g);break;case"imageBgOverlay":e(".awe-image-overlay",o).css("background-color",g);break;case"customID":o.attr("id",g);break;case"customClass":var r=a.model.previousAttributes().customClass;o.removeClass(r).addClass(g);break;case"customEnableAttributes":o.renderChangeSettingsAttributes(s,g,i.customDataAttributes);break;case"customActionAttributes":o.renderChangeSettingsAttributes(s,g);break;case"customEnableAnimations":var d,p;g?(d=i.customDataAnimations,p=null,o.processAnimations(d)):(d=null,p=i.customDataAnimations,o.processAnimations(d,p));break;case"customDataAnimations":var d,p;d=i.customDataAnimations,p=a.model.previousAttributes().customDataAnimations,o.processAnimations(d,p)}}),setTimeout(function(){a.checkChangeHeight(s)},100)},initMagnificPopup:function(t){AWEContent.jqIframe(t).magnificPopup({delegate:".open-lightbox",type:"image",removalDelay:300,mainClass:"mfp-fade",prependTo:".awe-page-wrapper",callbacks:{markupParse:function(t,a,i){var o=i.el.closest(".awe-item").find(".awe-image-caption");a.title="true"==o.attr("data-on-lightbox")?e("<div />").html(o.text()).css("color",o.css("color")):""}},image:{headerFit:!0,captionFit:!0,preserveHeaderAndCaptionWidth:!1}})},processImageURL:function(t,a,i,o){var a=this.model.get("fid"),n=this.model.get("styleImage"),l=this.model.get("styleLightbox"),s=o&&o[a]?o[a]:null;if(s&&void 0!==s[n]&&(this.model.imageURL=s[n],e("img",this.$el).attr("src",s[n])),s&&void 0!==s[l]&&(this.model.lighBoxImageURL=s[l],this.model.get("lightBox"))){var g=e(".awe-image",this.el);0==e("> a",g).length&&(g.prepend('<a class="mgf-md-popup" href=""></a>'),e("> a",g).append(e(".awe-image-content",g))),this.$imageWrap=e("> a",g),this.$imageWrap.addClass("open-lightbox").attr("href",s[l])}}}),AWEContent.Views.ImageItemController=AWEContent.Views.ItemController.extend({machineName:"image",controllerHtml:function(){return'<div class="title-icon">Image</div><i class="ic ac-icon-image2"></i>'},createItemModel:function(e){var t,a;return void 0!=e?(t=new AWEContent.Models.BoxModelSettings(e.boxModelSettings),e.boxModelSettings=t,a=new AWEContent.Models.ImageItem(e)):(a=new AWEContent.Models.ImageItem({boxModelSettings:new AWEContent.Models.BoxModelSettings({enabledCustomBorder:1})}),a.imageURL=a.lighBoxImageURL=AWEContent.Path.defaultImage),a}}),AWEContent.Views.ImagePanel=AWEContent.Views.ItemPanel.extend({tagName:"div",className:"awe-obj-panel image-panel",panelName:"image",initPanel:function(){AWEContent.Views.ItemPanel.prototype.initPanel.call(this);var t=this;t.$el.mousedown(function(){AWEContent.jqIframe(".mfp-close-btn-in").length&&AWEContent.jqIframe(".mfp-close-btn-in").trigger("click")}),e(".color-picker",t.el).append('<input type="hidden" name="changing-color">'),e("#image-select-image input[name=selected_media]",t.el).change(function(){var a=e(this).val().trim(),i=a?JSON.parse(a):!1,o=i&&i.file_url?i.file_url:"",n=i&&i.fid>0?i.fid:-1;e(".image-content > img",t.$el).attr("src",o),t.editingModel.set("fid",n)}),e("#image-thumb-style",this.el).change(function(e,a){t.editingModel.set("styleImage",a.value)}),e("#image-enable-lightbox input[name=toggle_value]",this.el).change(function(a,i){var o=parseInt(e(this).val());i||t.editingModel.set("lightBox",o),o?e("#image-on-lightbox , #image-lightbox-style, .image-lb-title",t.el).show():e("#image-on-lightbox, #image-lightbox-style, .image-lb-title",t.el).hide(),e("#image-caption-color",t.el).show(),t.editingModel.get("caption")||o&&t.editingModel.get("captionOnLightBox")||e("#image-caption-color",t.el).hide()}),e("#image-lightbox-style",this.el).change(function(e,a){t.editingModel.set("styleLightbox",a.value)}),e("#image-enable-caption input[name=toggle_value]",this.el).change(function(a,i){var o=parseInt(e(this).val());i||t.editingModel.set("caption",o),e("#image-position, #image-on-hover, #image-image-bg-overlay",t.el).hide(),o&&(e("#image-position",t.el).show(),"over"==t.editingModel.get("positionCaption")&&e("#image-on-hover, #image-image-bg-overlay",t.el).show()),e("#image-caption-color",t.el).show(),o||t.editingModel.get("lightBox")&&t.editingModel.get("captionOnLightBox")||e("#image-caption-color",t.el).hide()}),e("#image-position",this.el).change(function(a,i){t.editingModel.set("positionCaption",i.value),e("#image-on-hover, #image-image-bg-overlay",t.el).hide(),"over"==i.value&&t.editingModel.get("caption")&&e("#image-on-hover, #image-image-bg-overlay",t.el).show()}),e("#image-on-hover input[name=toggle_value]",this.el).change(function(a,i){i||t.editingModel.set("onHover",parseInt(e(this).val()))}),e("#image-image-bg-overlay",t.el).change(function(e,a){a=a?a.toRgbString():"",t.editingModel.set("imageBgOverlay",a)}),e("#image-caption-color",t.el).change(function(e,a){a=a?a.toRgbString():"",t.editingModel.set("captionColor",a)}),e("#image-on-lightbox input[name=toggle_value]",this.el).change(function(a,i){var o=parseInt(e(this).val());i||t.editingModel.set("captionOnLightBox",o),e("#image-caption-color",t.el).show(),o&&t.editingModel.get("lightBox")||t.editingModel.get("caption")||e("#image-caption-color",t.el).hide()}),e("#image-layout-tab",this.el).initBoxModelPanel(this,"boxModelSettings"),e("#text-image-custom-id",this.el).change(function(){t.editingModel.set("customID",e(this).val())}),e("#text-image-custom-classes",this.el).change(function(){t.editingModel.set("customClass",e(this).val())}),e("#image-custom-attributes",this.el).initAttributesPanel(t),e("#image-animations input[name=enabled_custom_animation]",this.el).change(function(a,i){t.editingModel.set("customEnableAnimations",parseInt(e(this).val())),i&&t.editingModel.set("customDataAnimations",JSON.stringify(i.animations))})},setPanelElementsValue:function(){var t=this,a=this.editingModel.toJSON();e("#image-select-image img",t.el).attr("src",t.editingModel.imageURL),""!=AWEContent.Path.imageStyleURL?(e("#image-thumb-style",t.el).aweSelect("value",a.styleImage),e("#image-lightbox-style",t.el).aweSelect("value",a.styleLightbox)):e("#image-thumb-style, #image-lightbox-style",t.el).remove(),e("#image-enable-lightbox input[name=toggle_value]",t.el).val(a.lightBox).trigger("change",!0),e("#image-enable-caption input[name=toggle_value]",t.el).val(a.caption).trigger("change",!0),e("#image-position",t.el).aweSelect("value",a.positionCaption),e("#image-on-hover input[name=toggle_value]",t.el).val(a.onHover).trigger("change",!0),e("#image-image-bg-overlay",t.el).aweColorPicker("value",a.imageBgOverlay),e("#image-caption-color",t.el).aweColorPicker("value",a.captionColor),e("#image-on-lightbox input[name=toggle_value]",t.el).val(a.captionOnLightBox).trigger("change",!0),e("#image-layout-tab",t.el).initBoxModel(a.boxModelSettings),e("#text-image-custom-id",t.el).val(a.customID),e("#text-image-custom-classes",t.el).val(a.customClass),e("#image-custom-attributes",this.el).initAttributes(a.customEnableAttributes,a.customDataAttributes),e("#image-animations input[name=enabled_custom_animation]",this.el).val(a.customEnableAnimations).trigger("change"),e("#image-animations input[name=enabled_custom_animation]",this.el).attr("data-animations",a.customDataAnimations).data("view",this.editingModel.view)},buildPanel:function(){return{title:{type:"markup",markup:'<div class="awe-title"><h2>Image</h2></div>'},custom_style:{type:"section",select_image:{type:"button",title:"Select Image"},thumb_style:{type:"image_style_list",title:"Image Style",attributes:{"class":["long-title"]}},enable_lightbox:{type:"toggle",title:"Enable Lightbox",default_value:0},lightbox_style:{type:"image_style_list",title:"LightBox Image Style",attributes:{"class":["long-title"]}}},custom_caption:{type:"section",enable_caption:{type:"toggle",title:"Caption",default_value:0},caption_color:{type:"colorpicker",title:"Caption Color",options:{preferredFormat:"rgb",AlphaVerticle:!0,showAlpha:!0,allowEmpty:!0,showInput:!0}},position:{type:"select",title:"Position",options:{top:"Top",bottom:"Bottom",over:"Over"},default_value:"top"},on_hover:{type:"toggle",title:"Display on hover",default_value:0},image_bg_overlay:{type:"colorpicker",title:"BgOverlay",options:{preferredFormat:"rgb",AlphaVerticle:!0,showAlpha:!0,allowEmpty:!0,showInput:!0}},on_lightbox:{type:"toggle",title:"Caption on lightbox",default_value:0}},box_settings:{type:"section",layout_tab:{type:"tabs",tabs:[{tab_title:"Border",contents:{header_border:{type:"box_border",min_value:0,max_value:100,default_value:0}}},{tab_title:"Radius",contents:{header_boder_radius:{type:"box_model",model_type:"border_radius",min_value:0,max_value:100,allow_type:!0}}},{tab_title:"Padding",contents:{header_padding:{type:"box_model",model_type:"padding",allow_type:!0,min_value:0,max_value:100}}},{tab_title:"Margin",contents:{header_margin:{type:"box_model",model_type:"margin",allow_type:!0,min_value:0,max_value:100}}}]}},definitions:{type:"section",custom_id:{type:"text_field",title:"ID",default_value:""},custom_classes:{type:"text_field",title:"Class",default_value:""},custom_attributes:{type:"custom_attributes"},animations:{type:"animations"}}}}}),e(document).ready(function(){AWEContent.Controllers.image=new AWEContent.Views.ImageItemController,AWEContent.Panels.image=new AWEContent.Views.ImagePanel})}(jQuery);